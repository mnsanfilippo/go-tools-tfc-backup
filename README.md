# GO Tools: terraform-cloud-backup

This tool saves the last Terraform state in S3. These are the resources needed:
[terraform-cloud-backup](https://github.com/mnsanfilippo/terraform-cloud-backup)

## Author
[Mariano Sanfilippo](https://www.linkedin.com/in/mariano-sanfilippo/)

## Usage
You can build this lambda on your own and upload it to S3, or you can fork this repo
and set up the GitHub Secrets to having the complete workflow.

## Automated Build
- Fork this repository
- Setup the following GitHub Secrets
  - FUNCTION_NAME
  - AWS_ACCESS_KEY_ID
  - AWS_SECRET_ACCESS_KEY
  - AWS_REGION
  - TF_TOKEN (Terraform Cloud token)
  - BUCKET (Bucket to save the Terraform states.)
  - BUCKET_BUILDS 
## Manual Build
```bash
  GOOS=linux GOARCH=amd64 CGO_ENABLED=0 
  go mod tidy 
  go build -ldflags="-s -w" -a -installsuffix cgo -o main main.go
  zip main.zip main
```
<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# go\-tools\-tfc\-backup

## Index

- [func DownloadBody(url string) (string, error)](<#func-downloadbody>)
- [func GetLastStateVersion(workspaceId string) (*tfe.StateVersion, error)](<#func-getlaststateversion>)
- [func Handler(ctx context.Context, event events.APIGatewayProxyRequest) (events.APIGatewayProxyResponse, error)](<#func-handler>)
- [func SaveLastState(payload Payload) (string, error)](<#func-savelaststate>)
- [func StatusModified(payload Payload) bool](<#func-statusmodified>)
- [func UploadToS3(key string, body string) error](<#func-uploadtos3>)
- [type Payload](<#type-payload>)


## func [DownloadBody](<https://github.com/mnsanfilippo/go-tools-tfc-backup/blob/main/main.go#L57>)

```go
func DownloadBody(url string) (string, error)
```

## func [GetLastStateVersion](<https://github.com/mnsanfilippo/go-tools-tfc-backup/blob/main/main.go#L70>)

```go
func GetLastStateVersion(workspaceId string) (*tfe.StateVersion, error)
```

## func [Handler](<https://github.com/mnsanfilippo/go-tools-tfc-backup/blob/main/main.go#L115>)

```go
func Handler(ctx context.Context, event events.APIGatewayProxyRequest) (events.APIGatewayProxyResponse, error)
```

## func [SaveLastState](<https://github.com/mnsanfilippo/go-tools-tfc-backup/blob/main/main.go#L88>)

```go
func SaveLastState(payload Payload) (string, error)
```

## func [StatusModified](<https://github.com/mnsanfilippo/go-tools-tfc-backup/blob/main/main.go#L108>)

```go
func StatusModified(payload Payload) bool
```

## func [UploadToS3](<https://github.com/mnsanfilippo/go-tools-tfc-backup/blob/main/main.go#L45>)

```go
func UploadToS3(key string, body string) error
```

## type [Payload](<https://github.com/mnsanfilippo/go-tools-tfc-backup/blob/main/main.go#L22-L40>)

```go
type Payload struct {
    PayloadVersion              int       `json:"payload_version"`
    NotificationConfigurationID string    `json:"notification_configuration_id"`
    RunURL                      string    `json:"run_url"`
    RunID                       string    `json:"run_id"`
    RunMessage                  string    `json:"run_message"`
    RunCreatedAt                time.Time `json:"run_created_at"`
    RunCreatedBy                string    `json:"run_created_by"`
    WorkspaceID                 string    `json:"workspace_id"`
    WorkspaceName               string    `json:"workspace_name"`
    OrganizationName            string    `json:"organization_name"`
    Notifications               []struct {
        Message      string    `json:"message"`
        Trigger      string    `json:"trigger"`
        RunStatus    string    `json:"run_status"`
        RunUpdatedAt time.Time `json:"run_updated_at"`
        RunUpdatedBy string    `json:"run_updated_by"`
    }   `json:"notifications"`
}
```



Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)
